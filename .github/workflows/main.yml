name: å¤©ç¿¼äº‘ç›˜ç­¾åˆ°

on:
  # æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # å®šæ—¶è¿è¡Œï¼šUTC 1:30 = åŒ—äº¬æ—¶é—´ 09:30ï¼Œæ¯å¤©ä¸€æ¬¡
  schedule:
    - cron: "30 1 * * *"

jobs:
  checkin:
    runs-on: ubuntu-latest
    # å…è®¸è¿™ä¸ªå·¥ä½œæµå¾€ä»“åº“é‡Œå†™å…¥ index.md
    permissions:
      contents: write

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # å¤šæ‹‰ä¸€ç‚¹å†å²ï¼Œé¿å…åˆ†å‰æ—¶å‡ºé—®é¢˜
          fetch-depth: 2

      # 2. å®‰è£… Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. è¿è¡Œç­¾åˆ°è„šæœ¬ï¼Œè¾“å‡ºåˆ° index.mdï¼Œå¹¶æŠŠå†…å®¹ä¼ ç»™åé¢çš„æ¨é€æ­¥éª¤
      - name: Run check-in script
        id: checkin
        env:
          TYYP_USERNAME: ${{ secrets.TYYP_USERNAME }}
          TYYP_PSW: ${{ secrets.TYYP_PSW }}
        run: |
          echo "å¼€å§‹å¤©ç¿¼äº‘ç›˜ç­¾åˆ°..."
          # ä»“åº“è‡ªå¸¦çš„ main.py ä¼šæ ¹æ® TYYP_USERNAME/TYYP_PSW è‡ªåŠ¨å¤„ç†è´¦å·å’Œç­¾åˆ°
          python main.py > index.md
          echo "ç­¾åˆ°å®Œæˆï¼Œç»“æœå·²å†™å…¥ index.md"

          # æŠŠ index.md å†…å®¹å†™åˆ°å½“å‰ step çš„è¾“å‡º DETAIL é‡Œï¼Œä¾›æ¨é€ä½¿ç”¨
          {
            echo "DETAIL<<'EOF'"
            cat index.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # 5. æäº¤ index.mdï¼ˆæ–¹ä¾¿åœ¨ä»“åº“é‡ŒæŸ¥çœ‹ç­¾åˆ°è®°å½•ï¼‰
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨ç­¾åˆ°æ›´æ–°"
          file_pattern: "index.md"
          skip_dirty_check: true
          # é¿å…ä½ ç‚¹ Re-run æ—¶å‡ºç°åˆ†å‰æ¨ä¸ä¸Šå»ï¼Œç›´æ¥å¼ºåˆ¶è¦†ç›–
          push_options: "--force"

      # 6. PushPlus æ¨é€æé†’ï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šå‘ï¼‰
      - name: Push notification (PushPlus)
        if: always()
        uses: dext7r/pushNotifications@v1.0.3
        with:
          TYPE: PushPlus
          TITLE: "å¤©ç¿¼äº‘ç›˜ç­¾åˆ°ç»“æœ"
          DESP: |
            æœ¬æ¬¡ç­¾åˆ°çŠ¶æ€ï¼š${{ job.status }}
            è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}ï¼ˆworkflow_dispatch=æ‰‹åŠ¨ï¼Œschedule=å®šæ—¶ï¼‰
            è¿è¡Œåˆ†æ”¯ï¼š${{ github.ref_name }}
            ä»“åº“ï¼š${{ github.repository }}

            è¿è¡Œæ—¥å¿—åœ°å€ï¼š
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ä¸‹é¢æ˜¯æœ¬æ¬¡è¯¦ç»†ç­¾åˆ°ç»“æœï¼ˆindex.md å†…å®¹ï¼‰ï¼š

            ${{ steps.checkin.outputs.DETAIL }}
          PUSH_PLUS_TOKEN: ${{ secrets.PUSH_PLUS_TOKEN }}
